#!/usr/bin/env node

/**
 * è¶…æ—¶ç”Ÿæ•ˆæ€§æµ‹è¯•è„šæœ¬
 */

console.log('ğŸ§ª è¶…æ—¶ç”Ÿæ•ˆæ€§æµ‹è¯•');
console.log('=================\n');

console.log('ğŸ“‹ æµ‹è¯•è¯´æ˜ï¼š');
console.log('-----------');
console.log('è¿™ä¸ªè„šæœ¬ä¼šæ¨¡æ‹Ÿä¸€ä¸ªéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ä»£ç ç”Ÿæˆè¯·æ±‚');
console.log('æ¥éªŒè¯CloudBaseçš„600ç§’è¶…æ—¶é…ç½®æ˜¯å¦ç”Ÿæ•ˆ');
console.log('');

console.log('âš ï¸  æ³¨æ„äº‹é¡¹ï¼š');
console.log('------------');
console.log('â€¢ éœ€è¦å…ˆç™»å½•åº”ç”¨è·å–æœ‰æ•ˆçš„access token');
console.log('â€¢ æµ‹è¯•ä¼šå‘é€çœŸå®è¯·æ±‚ï¼Œè¯·ç¡®ä¿AI APIå¯†é’¥æœ‰æ•ˆ');
console.log('â€¢ æµ‹è¯•å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…');
console.log('');

console.log('ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š');
console.log('-----------');
console.log('1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®æ‚¨çš„åº”ç”¨');
console.log('2. ç™»å½•è´¦å·');
console.log('3. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)');
console.log('4. åœ¨Consoleä¸­è¿è¡Œä»¥ä¸‹ä»£ç ï¼š');
console.log('');

console.log('```javascript');
// æµ‹è¯•ä»£ç 
console.log('console.log("ğŸš€ å¼€å§‹è¶…æ—¶æµ‹è¯•...");');
console.log('');
console.log('// è·å–è®¤è¯token');
console.log('const authState = JSON.parse(localStorage.getItem("app-auth-state") || "{}");');
console.log('const token = authState.accessToken;');
console.log('');
console.log('if (!token) {');
console.log('  console.log("âŒ è¯·å…ˆç™»å½•åº”ç”¨");');
console.log('  return;');
console.log('}');
console.log('');
console.log('console.log("âœ… å·²è·å–è®¤è¯token");');
console.log('');
console.log('// æµ‹è¯•ç”¨ä¾‹ï¼šä¸­ç­‰å¤æ‚åº¦æç¤ºï¼ˆé¢„è®¡éœ€è¦2-3åˆ†é’Ÿï¼‰');
console.log('const testPrompt = "åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡ç®¡ç†åº”ç”¨ï¼ŒåŒ…å«ç”¨æˆ·æ³¨å†Œç™»å½•ã€é¡¹ç›®åˆ›å»ºã€ä»»åŠ¡åˆ†é…ã€è¿›åº¦è·Ÿè¸ªã€æ–‡ä»¶ä¸Šä¼ ã€å›¢é˜Ÿåä½œã€æ—¶é—´ç»Ÿè®¡ã€é€šçŸ¥ç³»ç»Ÿã€æ•°æ®å¯¼å‡ºã€æƒé™ç®¡ç†ç­‰åŠŸèƒ½";');
console.log('');
console.log('// å‘é€è¯·æ±‚');
console.log('fetch("/api/generate-stream", {');
console.log('  method: "POST",');
console.log('  headers: {');
console.log('    "Content-Type": "application/json",');
console.log('    "Authorization": `Bearer ${token}`');
console.log('  },');
console.log('  body: JSON.stringify({');
console.log('    prompt: testPrompt,');
console.log('    model: "deepseek-chat"');
console.log('  })');
console.log('}).then(async (response) => {');
console.log('  console.log(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status}`);');
console.log('  ');
console.log('  if (!response.ok) {');
console.log('    const error = await response.text();');
console.log('    console.log("âŒ è¯·æ±‚å¤±è´¥:", error);');
console.log('    return;');
console.log('  }');
console.log('  ');
console.log('  console.log("âœ… è¯·æ±‚æˆåŠŸï¼Œå¼€å§‹ç›‘æ§æµå¼å“åº”...");');
console.log('  ');
console.log('  const reader = response.body.getReader();');
console.log('  const decoder = new TextDecoder();');
console.log('  ');
console.log('  let startTime = Date.now();');
console.log('  let heartbeatCount = 0;');
console.log('  let dataChunks = 0;');
console.log('  let lastActivity = Date.now();');
console.log('  ');
console.log('  function logProgress() {');
console.log('    const elapsed = Math.round((Date.now() - startTime) / 1000);');
console.log('    const sinceLast = Math.round((Date.now() - lastActivity) / 1000);');
console.log('    console.log(`â±ï¸  å·²è¿è¡Œ: ${elapsed}ç§’ | å¿ƒè·³: ${heartbeatCount} | æ•°æ®å—: ${dataChunks} | æœ€åæ´»åŠ¨: ${sinceLast}ç§’å‰`);');
console.log('  }');
console.log('  ');
console.log('  // æ¯30ç§’æŠ¥å‘Šä¸€æ¬¡è¿›åº¦');
console.log('  const progressInterval = setInterval(logProgress, 30000);');
console.log('  ');
console.log('  function readStream() {');
console.log('    reader.read().then(({done, value}) => {');
console.log('      if (done) {');
console.log('        clearInterval(progressInterval);');
console.log('        const totalTime = Math.round((Date.now() - startTime) / 1000);');
console.log('        console.log(`ğŸ‰ æµå¼å“åº”å®Œæˆï¼æ€»è€—æ—¶: ${totalTime}ç§’`);');
console.log('        console.log(`ğŸ“Š ç»Ÿè®¡: å¿ƒè·³åŒ…${heartbeatCount}ä¸ª, æ•°æ®å—${dataChunks}ä¸ª`);');
console.log('        ');
console.log('        if (totalTime > 90) { // è¶…è¿‡90ç§’');
console.log('          console.log("âœ… æˆåŠŸï¼ä»»åŠ¡è¿è¡Œè¶…è¿‡1åˆ†30ç§’ï¼Œè¶…æ—¶é…ç½®ç”Ÿæ•ˆ");');
console.log('        } else {');
console.log('          console.log("âš ï¸  ä»»åŠ¡è¾ƒå¿«å®Œæˆï¼Œå¯èƒ½éœ€è¦æµ‹è¯•æ›´å¤æ‚çš„æç¤º");');
console.log('        }');
console.log('        return;');
console.log('      }');
console.log('      ');
console.log('      lastActivity = Date.now();');
console.log('      const chunk = decoder.decode(value, {stream: true});');
console.log('      const lines = chunk.split("\\n");');
console.log('      ');
console.log('      lines.forEach(line => {');
console.log('        if (line.startsWith("data: ")) {');
console.log('          try {');
console.log('            const data = JSON.parse(line.slice(6));');
console.log('            ');
console.log('            if (data.type === "heartbeat") {');
console.log('              heartbeatCount++;');
console.log('              console.log(`â¤ï¸ å¿ƒè·³åŒ… #${heartbeatCount} - ${new Date().toLocaleTimeString()}`);');
console.log('            } else if (data.type === "chars") {');
console.log('              dataChunks++;');
console.log('              console.log(`ğŸ“ ä»£ç ç‰‡æ®µ #${dataChunks} (${data.chars?.length || 0}å­—ç¬¦)`);');
console.log('            } else if (data.type === "complete") {');
console.log('              console.log("âœ… ç”Ÿæˆå®Œæˆï¼");');
console.log('            } else if (data.type === "mode_switch") {');
console.log('              console.log("ğŸ”„ æ™ºèƒ½åˆ‡æ¢åˆ°å¼‚æ­¥æ¨¡å¼:", data.reason);');
console.log('            } else if (data.type === "error") {');
console.log('              console.log("âŒ é”™è¯¯:", data.error);');
console.log('            }');
console.log('            ');
console.log('          } catch (e) {');
console.log('            // å¿½ç•¥è§£æé”™è¯¯');
console.log('          }');
console.log('        }');
console.log('      });');
console.log('      ');
console.log('      readStream();');
console.log('    }).catch(error => {');
console.log('      clearInterval(progressInterval);');
console.log('      console.log("âŒ æµå¼è¯»å–é”™è¯¯:", error.message);');
console.log('      ');
console.log('      const elapsed = Math.round((Date.now() - startTime) / 1000);');
console.log('      if (elapsed < 60) {');
console.log('        console.log("âš ï¸  æå‰å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨é…ç½®é—®é¢˜");');
console.log('      } else {');
console.log('        console.log(`âœ… è¿è¡Œäº†${elapsed}ç§’æ‰å¤±è´¥ï¼Œè¶…æ—¶é…ç½®å¯èƒ½ç”Ÿæ•ˆä½†é‡åˆ°å…¶ä»–é—®é¢˜`);');
console.log('      }');
console.log('    });');
console.log('  }');
console.log('  ');
console.log('  readStream();');
console.log('}).catch(error => {');
console.log('  console.log("âŒ è¯·æ±‚å‘é€å¤±è´¥:", error.message);');
console.log('});');
console.log('```');
console.log('');

console.log('ğŸ¯ éªŒè¯æ ‡å‡†ï¼š');
console.log('-----------');
console.log('âœ… æˆåŠŸæ ‡å¿—ï¼š');
console.log('   â€¢ å¿ƒè·³åŒ…æŒç»­å‘é€è¶…è¿‡2åˆ†é’Ÿ');
console.log('   â€¢ æ”¶åˆ°å¤šä¸ªä»£ç æ•°æ®å—');
console.log('   â€¢ æ— "1åˆ†é’Ÿè¶…æ—¶"é”™è¯¯');
console.log('   â€¢ ä»»åŠ¡æœ€ç»ˆå®Œæˆ');
console.log('');
console.log('âŒ å¤±è´¥æ ‡å¿—ï¼š');
console.log('   â€¢ 60ç§’å†…è¿æ¥æ–­å¼€');
console.log('   â€¢ æ”¶åˆ°è¶…æ—¶é”™è¯¯');
console.log('   â€¢ å¿ƒè·³åŒ…åœæ­¢å‘é€');
console.log('');

console.log('ğŸš€ ç°åœ¨å¼€å§‹æµ‹è¯•å§ï¼');
console.log('==================');
console.log('å¤åˆ¶ä¸Šé¢çš„JavaScriptä»£ç åˆ°æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ');
console.log('è§‚å¯Ÿè¾“å‡ºç»“æœï¼ŒéªŒè¯600ç§’è¶…æ—¶é…ç½®æ˜¯å¦ç”Ÿæ•ˆ');
