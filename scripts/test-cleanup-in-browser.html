<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•è®¢é˜…è¿‡æœŸæ¸…ç†åŠŸèƒ½</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success {
      color: #4CAF50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
    .warning {
      color: #ff9800;
      font-weight: bold;
    }
    .info {
      color: #2196F3;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª è®¢é˜…è¿‡æœŸæ¸…ç†åŠŸèƒ½æµ‹è¯•</h1>

    <div class="section">
      <h3>æ­¥éª¤ 1: è·å– Token</h3>
      <p>è¯·å…ˆç™»å½•åˆ°ä½ çš„åº”ç”¨,ç„¶ååœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹ä»£ç è·å– token:</p>
      <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
localStorage.getItem('cloudbase_session')
// æˆ–è€…
JSON.parse(localStorage.getItem('app-auth-state') || '{}').accessToken</pre>
      <input type="text" id="accessToken" placeholder="ç²˜è´´ä½ çš„ access token" style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <button onclick="setToken()">è®¾ç½® Token</button>
    </div>

    <div class="section">
      <h3>æ­¥éª¤ 2: æµ‹è¯• API</h3>
      <button id="btnStats" onclick="testGetStats()" disabled>ğŸ“Š æŸ¥çœ‹è¿‡æœŸè®¢é˜…ç»Ÿè®¡</button>
      <button id="btnCleanup" onclick="testCleanup()" disabled>ğŸ§¹ æ‰§è¡Œæ‰¹é‡æ¸…ç†</button>
      <button onclick="clearOutput()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º</button>
    </div>

    <div class="section">
      <h3>æ­¥éª¤ 3: æµ‹è¯•è‡ªåŠ¨è¿‡æœŸæ£€æµ‹</h3>
      <p>ç”Ÿæˆä»£ç å,æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—,çœ‹æ˜¯å¦æœ‰è¿‡æœŸæ£€æµ‹ç›¸å…³çš„æ—¥å¿—:</p>
      <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px;">
[CloudBase Plan] User xxx subscription expired at...
[Subscription Cleanup] Updating expired subscription...</pre>
    </div>

    <div id="output" class="output">ç­‰å¾…æ“ä½œ...</div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let accessToken = '';

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = {
        'success': 'âœ…',
        'error': 'âŒ',
        'warning': 'âš ï¸',
        'info': 'â„¹ï¸'
      }[type];

      output.innerHTML += `\n[${timestamp}] ${prefix} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function setToken() {
      accessToken = document.getElementById('accessToken').value.trim();
      if (!accessToken) {
        log('è¯·è¾“å…¥æœ‰æ•ˆçš„ access token', 'error');
        return;
      }
      log('Token å·²è®¾ç½®', 'success');
      document.getElementById('btnStats').disabled = false;
      document.getElementById('btnCleanup').disabled = false;
    }

    async function testGetStats() {
      log('å¼€å§‹æŸ¥è¯¢è¿‡æœŸè®¢é˜…ç»Ÿè®¡...', 'info');

      try {
        const response = await fetch(`${API_BASE}/api/subscription/cleanup-expired`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (response.ok) {
          log('æŸ¥è¯¢æˆåŠŸ!', 'success');
          log(`æ€»æ´»è·ƒè®¢é˜…æ•°: ${data.stats.totalActive}`, 'info');
          log(`å·²è¿‡æœŸæ•°: ${data.stats.expired}`, 'warning');
          log(`ä»æ´»è·ƒæ•°: ${data.stats.active}`, 'info');

          if (data.expiredSubscriptions && data.expiredSubscriptions.length > 0) {
            log(`\nè¿‡æœŸè®¢é˜…è¯¦æƒ…:`, 'info');
            data.expiredSubscriptions.forEach((sub, index) => {
              log(`\n${index + 1}. è®¢é˜…ID: ${sub.id}`, 'info');
              log(`   ç”¨æˆ·ID: ${sub.userId}`, 'info');
              log(`   è®¡åˆ’ç±»å‹: ${sub.plan}`, 'info');
              log(`   è¿‡æœŸæ—¶é—´: ${sub.subscriptionEnd}`, 'info');
              log(`   å·²è¿‡æœŸå¤©æ•°: ${sub.daysSinceExpiry} å¤©`, 'warning');
            });
          } else {
            log('\nâœ… æ²¡æœ‰æ‰¾åˆ°è¿‡æœŸçš„è®¢é˜…', 'success');
          }
        } else {
          log(`æŸ¥è¯¢å¤±è´¥: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testCleanup() {
      const confirmed = confirm('âš ï¸ è­¦å‘Š: æ­¤æ“ä½œå°†æ›´æ–°æ•°æ®åº“ä¸­çš„è®¢é˜…çŠ¶æ€\n\nç¡®å®šè¦æ‰§è¡Œæ¸…ç†å—?');
      if (!confirmed) return;

      log('å¼€å§‹æ‰§è¡Œæ‰¹é‡æ¸…ç†...', 'info');

      try {
        const response = await fetch(`${API_BASE}/api/subscription/cleanup-expired`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (response.ok) {
          log('æ¸…ç†æˆåŠŸ!', 'success');
          log(`æ¶ˆæ¯: ${data.message}`, 'info');
          log(`æˆåŠŸæ¸…ç†æ•°: ${data.cleaned}`, 'success');
          log(`å¤±è´¥æ•°: ${data.failed}`, data.failed > 0 ? 'error' : 'info');

          if (data.results && data.results.length > 0) {
            log(`\nè¯¦ç»†ç»“æœ:`, 'info');
            data.results.forEach((result, index) => {
              if (result.success) {
                log(`\nâœ… ${index + 1}. è®¢é˜… ${result.subscriptionId.substring(0, 8)}...`, 'success');
                log(`   ç”¨æˆ·: ${result.userId}`, 'info');
                log(`   è®¡åˆ’: ${result.plan}`, 'info');
                log(`   è¿‡æœŸæ—¶é—´: ${result.expiredAt}`, 'info');
              } else {
                log(`\nâŒ ${index + 1}. è®¢é˜… ${result.subscriptionId?.substring(0, 8)}... å¤±è´¥`, 'error');
                log(`   é”™è¯¯: ${result.error}`, 'error');
              }
            });
          }
        } else {
          log(`æ¸…ç†å¤±è´¥: ${data.error}`, 'error');
          if (data.details) {
            log(`è¯¦ç»†é”™è¯¯: ${data.details}`, 'error');
          }
        }
      } catch (error) {
        log(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = 'è¾“å‡ºå·²æ¸…ç©º...\n';
    }

    // é¡µé¢åŠ è½½æ—¶çš„æç¤º
    log('æ¬¢è¿ä½¿ç”¨è®¢é˜…è¿‡æœŸæ¸…ç†åŠŸèƒ½æµ‹è¯•å·¥å…·!', 'success');
    log('è¯·æŒ‰ç…§æ­¥éª¤æ“ä½œ:\n1. å…ˆè·å–å¹¶è®¾ç½® token\n2. æŸ¥çœ‹è¿‡æœŸè®¢é˜…ç»Ÿè®¡\n3. æ‰§è¡Œæ‰¹é‡æ¸…ç†(å¯é€‰)\n4. æµ‹è¯•è‡ªåŠ¨è¿‡æœŸæ£€æµ‹', 'info');
  </script>
</body>
</html>
