<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯çŠ¶æ€è°ƒè¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .debug-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .token-display {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 5px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>ğŸ” CloudBaseè®¤è¯çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
    <p>æ­¤å·¥å…·ç”¨äºæ£€æŸ¥æµè§ˆå™¨ä¸­çš„è®¤è¯çŠ¶æ€å’ŒlocalStorageæ•°æ®ã€‚</p>

    <div class="debug-section">
        <div class="debug-title">ğŸ“Š è®¤è¯çŠ¶æ€æ£€æŸ¥</div>
        <div id="auth-status">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="debug-section">
        <div class="debug-title">ğŸ’¾ localStorageæ•°æ®</div>
        <div id="localstorage-data">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="debug-section">
        <div class="debug-title">ğŸ”‘ JWT TokenéªŒè¯</div>
        <div id="jwt-validation">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="debug-section">
        <div class="debug-title">ğŸŒ APIè¿æ¥æµ‹è¯•</div>
        <div id="api-test">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="debug-section">
        <div class="debug-title">ğŸ› ï¸ è°ƒè¯•æ“ä½œ</div>
        <button onclick="checkAuthStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="clearAuthData()">æ¸…é™¤è®¤è¯æ•°æ®</button>
        <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
        <button onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨</button>
    </div>

    <script>
        const AUTH_STATE_KEY = "app-auth-state";

        async function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...</div>';

            try {
                // æ£€æŸ¥localStorage
                const authStateStr = localStorage.getItem(AUTH_STATE_KEY);
                let authState = null;

                if (authStateStr) {
                    try {
                        authState = JSON.parse(authStateStr);
                    } catch (e) {
                        statusDiv.innerHTML = '<div class="error">âŒ localStorageä¸­çš„è®¤è¯æ•°æ®æ ¼å¼é”™è¯¯</div>';
                        return;
                    }
                }

                let html = '';

                if (authState) {
                    html += '<div class="success">âœ… å‘ç°è®¤è¯çŠ¶æ€æ•°æ®</div>';

                    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                    const checks = [
                        { key: 'accessToken', label: 'è®¿é—®ä»¤ç‰Œ', value: authState.accessToken },
                        { key: 'refreshToken', label: 'åˆ·æ–°ä»¤ç‰Œ', value: authState.refreshToken },
                        { key: 'user.id', label: 'ç”¨æˆ·ID', value: authState.user?.id },
                        { key: 'user.email', label: 'ç”¨æˆ·é‚®ç®±', value: authState.user?.email },
                        { key: 'tokenMeta', label: 'ä»¤ç‰Œå…ƒæ•°æ®', value: authState.tokenMeta }
                    ];

                    checks.forEach(check => {
                        if (check.value) {
                            html += `<div class="success">âœ… ${check.label}: ${typeof check.value === 'string' && check.value.length > 20 ? check.value.substring(0, 20) + '...' : check.value}</div>`;
                        } else {
                            html += `<div class="error">âŒ ${check.label}: ç¼ºå¤±</div>`;
                        }
                    });

                    // æ£€æŸ¥ä»¤ç‰Œè¿‡æœŸæ—¶é—´
                    if (authState.tokenMeta) {
                        const now = Date.now();
                        const accessExpire = authState.savedAt + (authState.tokenMeta.accessTokenExpiresIn * 1000);
                        const refreshExpire = authState.savedAt + (authState.tokenMeta.refreshTokenExpiresIn * 1000);

                        const accessExpired = now > accessExpire;
                        const refreshExpired = now > refreshExpire;

                        html += `<div class="${accessExpired ? 'error' : 'success'}">${accessExpired ? 'âŒ' : 'âœ…'} è®¿é—®ä»¤ç‰Œ${accessExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}</div>`;
                        html += `<div class="${refreshExpired ? 'error' : 'success'}">${refreshExpired ? 'âŒ' : 'âœ…'} åˆ·æ–°ä»¤ç‰Œ${refreshExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}</div>`;
                    }

                } else {
                    html = '<div class="warning">âš ï¸ æœªå‘ç°è®¤è¯çŠ¶æ€æ•°æ®ï¼Œè¯·å…ˆç™»å½•</div>';
                }

                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message + '</div>';
            }
        }

        function showLocalStorageData() {
            const dataDiv = document.getElementById('localstorage-data');
            const authStateStr = localStorage.getItem(AUTH_STATE_KEY);

            if (authStateStr) {
                try {
                    const authState = JSON.parse(authStateStr);
                    dataDiv.innerHTML = `
                        <div class="success">âœ… å‘ç°è®¤è¯æ•°æ®</div>
                        <pre class="token-display">${JSON.stringify(authState, null, 2)}</pre>
                    `;
                } catch (e) {
                    dataDiv.innerHTML = `
                        <div class="error">âŒ æ•°æ®è§£æå¤±è´¥</div>
                        <div class="token-display">${authStateStr}</div>
                    `;
                }
            } else {
                dataDiv.innerHTML = '<div class="warning">âš ï¸ localStorageä¸­æ²¡æœ‰è®¤è¯æ•°æ®</div>';
            }
        }

        async function validateJwtToken() {
            const validationDiv = document.getElementById('jwt-validation');
            const authStateStr = localStorage.getItem(AUTH_STATE_KEY);

            if (!authStateStr) {
                validationDiv.innerHTML = '<div class="warning">âš ï¸ æ²¡æœ‰ä»¤ç‰Œæ•°æ®å¯éªŒè¯</div>';
                return;
            }

            try {
                const authState = JSON.parse(authStateStr);
                const token = authState.accessToken;

                if (!token) {
                    validationDiv.innerHTML = '<div class="error">âŒ æ²¡æœ‰è®¿é—®ä»¤ç‰Œ</div>';
                    return;
                }

                // è°ƒç”¨åç«¯éªŒè¯API
                const response = await fetch('/api/debug-auth', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    validationDiv.innerHTML = `
                        <div class="success">âœ… ä»¤ç‰ŒéªŒè¯æˆåŠŸ</div>
                        <div>ç”¨æˆ·ID: ${result.user?.id || 'æœªçŸ¥'}</div>
                        <div>ç”¨æˆ·é‚®ç®±: ${result.user?.email || 'æœªçŸ¥'}</div>
                    `;
                } else {
                    validationDiv.innerHTML = `
                        <div class="error">âŒ ä»¤ç‰ŒéªŒè¯å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>
                        <div>å“åº”çŠ¶æ€: ${response.status}</div>
                    `;
                }

            } catch (error) {
                validationDiv.innerHTML = '<div class="error">âŒ éªŒè¯è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message + '</div>';
            }
        }

        async function testApiConnection() {
            const apiDiv = document.getElementById('api-test');
            apiDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';

            try {
                // æµ‹è¯•æ— è®¤è¯çš„API
                const envResponse = await fetch('/api/env');
                const envData = await envResponse.json();

                let html = '';

                if (envResponse.ok) {
                    html += '<div class="success">âœ… /api/env è¿æ¥æ­£å¸¸</div>';
                    html += `<div>ç¯å¢ƒID: ${envData.env?.NEXT_PUBLIC_TENCENT_CLOUD_ENV_ID || 'æœªçŸ¥'}</div>`;
                } else {
                    html += '<div class="error">âŒ /api/env è¿æ¥å¤±è´¥</div>';
                }

                // æµ‹è¯•éœ€è¦è®¤è¯çš„API
                const authStateStr = localStorage.getItem(AUTH_STATE_KEY);
                if (authStateStr) {
                    const authState = JSON.parse(authStateStr);
                    const token = authState.accessToken;

                    if (token) {
                        const authResponse = await fetch('/api/subscription/status', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (authResponse.ok) {
                            html += '<div class="success">âœ… è®¤è¯APIè¿æ¥æ­£å¸¸</div>';
                        } else if (authResponse.status === 401) {
                            html += '<div class="error">âŒ è®¤è¯APIè¿”å›401 (Unauthorized)</div>';
                        } else {
                            html += `<div class="warning">âš ï¸ è®¤è¯APIè¿”å› ${authResponse.status}</div>`;
                        }
                    }
                }

                apiDiv.innerHTML = html;

            } catch (error) {
                apiDiv.innerHTML = '<div class="error">âŒ APIæµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        function clearAuthData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®å—ï¼Ÿè¿™å°†å¯¼è‡´éœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                localStorage.removeItem(AUTH_STATE_KEY);
                console.log('å·²æ¸…é™¤è®¤è¯æ•°æ®');
                checkAuthStatus();
                showLocalStorageData();
            }
        }

        function openMainApp() {
            window.open('/', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkAuthStatus();
            showLocalStorageData();
            validateJwtToken();
            testApiConnection();
        };

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        setInterval(() => {
            checkAuthStatus();
            showLocalStorageData();
        }, 30000);
    </script>
</body>
</html>


