# 🔐 CloudBase 集合权限设置完整指南

## 🚨 紧急问题：支付记录无法保存

**问题诊断结果：**
- ❌ payments 集合读取权限：无
- ❌ payments 集合写入权限：无
- ❌ 所有其他集合权限：未知

**根本原因：** CloudBase 数据库集合权限未正确设置，导致支付记录和订阅数据无法保存。

## 🛠️ 解决方案：设置集合权限

### 步骤1: 登录CloudBase控制台
```
🌐 地址: https://console.cloud.tencent.com/tcb
📧 使用你的腾讯云账号登录
```

### 步骤2: 选择正确环境
```
🏠 进入控制台后:
1. 点击左侧菜单 "环境"
2. 选择环境: cloud1-3gn61ziydcfe6a57
3. 如果没有看到此环境，请确认环境ID是否正确
```

### 步骤3: 进入数据库管理
```
🗄️ 在环境页面:
1. 点击左侧菜单 "数据库"
2. 点击 "集合管理" 标签
```

### 步骤4: 设置集合权限

#### 需要设置的集合列表：
```
1. payments           - 支付记录 ✅
2. user_subscriptions - 用户订阅 ✅
3. conversations      - 对话记录 ✅
4. conversation_messages - 对话消息 ✅
5. conversation_files - 对话文件 ✅
6. users              - 用户信息 ✅
7. user_github_tokens - GitHub令牌 ✅
```

#### 权限设置步骤：
```
🔧 为每个集合执行以下操作:

1. 在集合列表中点击集合名称
2. 在右侧找到 "权限设置"
3. 设置以下权限:
   • 读取: true ✅
   • 写入: true ✅
4. 点击 "保存" 按钮
```

#### 详细截图说明：
```
集合权限设置界面应该显示:
┌─────────────────┐
│ 权限设置        │
├─────────────────┤
│ 读取    [✓]     │
│ 写入    [✓]     │
└─────────────────┘
```

### 步骤5: 验证权限设置

#### 方法1: 使用测试脚本
```bash
# 测试所有集合权限
node scripts/test-cloudbase-service.js
```

#### 方法2: 手动验证
```
预期结果:
✅ CloudBase连接成功
✅ Payments集合查询: 成功
✅ 测试集合写入: 成功 (或显示适当的集合不存在错误)
```

### 步骤6: 重新测试支付功能

#### 6.1 测试支付记录保存
```bash
node scripts/test-payments-write.js
```
**预期结果:**
```
✅ 支付API调用成功
✅ 写入结果: 成功
🎉 写入权限正常！支付记录可以保存。
```

#### 6.2 测试完整支付流程
```bash
node scripts/test-complete-payment-flow.js
```
**预期结果:**
```
✅ 支付订单创建成功
✅ 支付记录已成功保存到数据库！
✅ 模拟webhook调用完成
🎉 用户订阅已升级为 Pro
```

## 🔍 常见问题排查

### 问题1: 找不到环境
```
❌ 错误: cloud1-3gn61ziydcfe6a57 环境不存在

🔧 解决:
1. 检查环境ID是否正确
2. 确认你有权限访问此环境
3. 如果是新环境，可能需要先创建
```

### 问题2: 集合不存在
```
❌ 错误: 集合 [name] 不存在

🔧 解决:
1. 在集合管理页面点击 "创建集合"
2. 输入集合名称
3. 创建后设置权限
```

### 问题3: 权限设置无效
```
❌ 错误: 权限设置后仍无法写入

🔧 解决:
1. 确认设置已保存 (点击保存按钮)
2. 等待1-2分钟让权限生效
3. 检查是否登录了正确的账号
4. 确认环境ID正确
```

### 问题4: 仍然显示权限错误
```
❌ 仍然报错: 数据库集合无法访问

🔧 解决:
1. 清除浏览器缓存
2. 重启应用服务器
3. 检查网络连接
4. 联系腾讯云客服
```

## 🎯 权限设置完成后的验证

### 验证脚本运行结果：
```bash
✅ CloudBase连接成功
✅ Payments集合查询: 成功
✅ 测试集合写入: 成功
🎉 所有集合权限设置正确
```

### 支付功能测试结果：
```bash
✅ 支付订单创建成功
✅ 支付记录保存成功
✅ 订阅升级成功
🎉 完整支付流程正常工作
```

## 📞 技术支持

如果按照上述步骤操作后仍然有问题：

1. **截图保存** - 保存CloudBase控制台的错误信息
2. **日志查看** - 查看浏览器开发者工具的网络请求
3. **环境确认** - 确认使用的环境ID和账号权限
4. **联系支持** - 提供详细的错误信息和操作步骤

---

## 🚀 立即行动

**现在就开始设置权限：**

1. 🔗 打开 [CloudBase控制台](https://console.cloud.tencent.com/tcb)
2. 🏠 选择环境 `cloud1-3gn61ziydcfe6a57`
3. 🗄️ 进入数据库 > 集合管理
4. ✅ 为所有集合设置读取和写入权限
5. 🧪 运行测试脚本验证

**设置完成后，你的支付功能就会完全正常工作！** 🎉💰


